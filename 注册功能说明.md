# 用户注册功能实现说明

## 功能概述
已在登录界面添加注册功能，新注册的用户将被分配为"普通注册用户"角色，该角色无后台管理权限。

## 实施步骤

### 1. 前端修改
- **文件**: `ruoyi-ui/src/views/login.vue`
- **修改内容**: 将注册开关 `register` 设置为 `true`，在登录页面显示"立即注册"链接

### 2. 数据库配置

#### 2.1 创建普通注册用户角色
执行以下SQL脚本创建新角色：
```sql
-- 执行文件: sql/add_ordinary_user_role.sql
INSERT INTO sys_role VALUES('100', '普通注册用户', 'registered_user', 100, 2, 1, 1, '0', '0', 'admin', sysdate(), '', null, '通过注册功能注册的普通用户，无后台管理权限');
```

**角色说明**:
- 角色ID: 100
- 角色名称: 普通注册用户
- 角色权限字符: registered_user
- 该角色不分配任何后台菜单权限，因此无法访问后台管理系统

#### 2.2 开启注册功能
执行以下SQL脚本开启系统注册功能：
```sql
-- 执行文件: sql/enable_registration.sql
UPDATE sys_config SET config_value = 'true' WHERE config_key = 'sys.account.registerUser';
```

### 3. 后端修改
- **文件**: `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysUserServiceImpl.java`
- **修改内容**: 修改 `registerUser` 方法，自动为新注册用户分配角色ID为100的"普通注册用户"角色

```java
@Override
@Transactional
public boolean registerUser(SysUser user)
{
    // 插入用户信息
    int rows = userMapper.insertUser(user);
    if (rows > 0)
    {
        // 为新注册用户分配普通注册用户角色（role_id = 100）
        Long[] roleIds = new Long[]{100L};
        insertUserRole(user.getUserId(), roleIds);
    }
    return rows > 0;
}
```

## 部署说明

### 按顺序执行以下步骤：

1. **执行数据库脚本**
   ```bash
   # 1. 创建普通注册用户角色
   mysql -u root -p your_database < sql/add_ordinary_user_role.sql
   
   # 2. 开启注册功能
   mysql -u root -p your_database < sql/enable_registration.sql
   ```

2. **重新编译后端**
   ```bash
   cd ruoyi-admin
   mvn clean package
   ```

3. **重新编译前端**
   ```bash
   cd ruoyi-ui
   npm run build:prod
   ```

4. **重启应用**
   - 重启后端服务
   - 部署前端静态文件

## 功能验证

1. **访问登录页面**
   - 应该能看到"立即注册"链接

2. **注册新用户**
   - 点击"立即注册"
   - 填写用户名、密码、确认密码和验证码
   - 提交注册

3. **验证权限限制**
   - 使用新注册的账号登录
   - 确认无法访问后台管理系统（/index路径）
   - 只能访问前台页面（如 /exam-home）

## 权限说明

### 普通注册用户（role_id = 100）
- ✅ 可以登录系统
- ✅ 可以访问前台页面
- ❌ 无法访问后台管理系统
- ❌ 无后台菜单权限

### 如需为注册用户添加特定权限
可以在 `sys_role_menu` 表中为角色ID 100 添加相应的菜单权限：
```sql
-- 示例：为普通注册用户添加某个菜单权限
INSERT INTO sys_role_menu VALUES ('100', '菜单ID');
```

## 注意事项

1. 确保角色ID 100 在数据库中不存在冲突
2. 如果需要修改默认角色ID，需要同时修改：
   - SQL脚本中的角色ID
   - `SysUserServiceImpl.java` 中的 `roleIds` 数组值
3. 注册功能开关可以在系统管理 -> 参数设置中动态修改 `sys.account.registerUser` 配置项

## 相关文件清单

### 前端文件
- `ruoyi-ui/src/views/login.vue` - 登录页面（已修改）
- `ruoyi-ui/src/views/register.vue` - 注册页面（已存在）
- `ruoyi-ui/src/api/login.js` - 登录注册API（已存在）

### 后端文件
- `ruoyi-system/src/main/java/com/ruoyi/system/service/impl/SysUserServiceImpl.java` - 用户服务实现（已修改）
- `ruoyi-admin/src/main/java/com/ruoyi/web/controller/system/SysRegisterController.java` - 注册控制器（已存在）
- `ruoyi-framework/src/main/java/com/ruoyi/framework/web/service/SysRegisterService.java` - 注册服务（已存在）

### SQL脚本
- `sql/add_ordinary_user_role.sql` - 创建普通注册用户角色（新增）
- `sql/enable_registration.sql` - 开启注册功能（新增）
